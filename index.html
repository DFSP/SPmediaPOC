<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ë””ì§€í„¸í¼ìŠ¤íŠ¸] ë¯¸ë””ì–´ POC ë¦¬ìŠ¤íŠ¸</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/hangul-js"></script> 
    
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>

    <style>
        /* Tailwind CSSë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜, ì¶”ê°€ì ì¸ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ì„ ì ìš©í•©ë‹ˆë‹¤. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            padding-bottom: 2.5rem; /* í•˜ë‹¨ ë°°ë„ˆ ê³µê°„ í™•ë³´ */
        }
        #login-screen, #main-content {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ ìˆ¨ê¹€ */
        }
        /* ... (ì´í•˜ ìŠ¤íƒ€ì¼ì€ ë™ì¼) ... */
        .toast-notification {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .category-tag {
            transition: all 0.2s ease-in-out;
        }
        input[type="file"] {
            display: none;
        }
        .edit-input {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .dark .edit-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        .edit-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .scrolling-banner-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }
        .scrolling-banner-content {
            display: inline-block;
        }
        .scrolling-banner-content.animate {
            animation: marquee 80s linear infinite;
        }
        @keyframes marquee {
            from { transform: translateX(0); }
            to { transform: translateX(var(--scroll-width)); }
        }

        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ëˆˆì´ í´ë¦­ì„ ë°©í•´í•˜ì§€ ì•Šê²Œ ì„¤ì • */
            z-index: 9999;
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    
    <canvas id="snow-canvas"></canvas>
    
    <div id="login-screen" class="flex min-h-screen items-center justify-center">
        <div class="w-full max-w-md rounded-lg bg-white p-8 text-center shadow-xl dark:bg-gray-800">
            <h1 class="mb-4 text-2xl font-bold text-gray-800 dark:text-white">[ë””ì§€í„¸í¼ìŠ¤íŠ¸] ë¯¸ë””ì–´ POC ë¦¬ìŠ¤íŠ¸</h1>
            <p class="mb-8 text-sm text-gray-500 dark:text-gray-400">íšŒì‚¬ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
            <button id="login-button" class="inline-flex w-full items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-center text-sm font-medium text-gray-700 shadow-sm transition hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-700">
                <svg class="mr-2 h-4 w-4" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 177.2 56.5L357 137.9C332.3 115.8 293.8 98 248 98c-84.3 0-152.3 68.3-152.3 158s68 158 152.3 158c94.2 0 135.8-63.5 141.2-95.2H248v-65.7h239.2c.4 12.3.6 24.6.6 37.3z"></path></svg>
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
        </div>
    </div>
    
    <div id="main-content">
        <div class="scrolling-banner-container bg-red-100/50 text-red-600 dark:bg-red-900/50 dark:text-red-300">
            <div class="scrolling-banner-content py-1 text-xs font-semibold">
                <span>ë””ì§€í„¸í¼ìŠ¤íŠ¸ ë‚´ë¶€ ë°°í¬ ìë£Œì…ë‹ˆë‹¤. URLì™¸ë¶€ ê³µìœ  ê¸ˆì§€.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            </div>
        </div>

        <div id="toast-container" class="fixed top-5 right-5 z-50"></div>
        
        <div class="container mx-auto p-4 md:p-8 max-w-5xl">
            <header class="relative mb-8 rounded-t-lg border-b-4 border-blue-600 bg-white py-8 text-center shadow-sm transition-colors duration-300 dark:bg-gray-800">
                
            <div id="user-menu-container" class="absolute top-6 right-6 z-20" style="display: none;">
                <div class="flex items-center gap-x-2">
            
                    <button id="theme-toggle-button" type="button" class="flex h-8 w-8 items-center justify-center rounded-full bg-white/80 dark:bg-gray-800/80 text-gray-500 dark:text-gray-400 ring-1 ring-gray-900/5 dark:ring-white/10 transition hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none" aria-label="í™”ë©´ ëª¨ë“œ ë³€ê²½">
                        <span class="sr-only">í™”ë©´ ëª¨ë“œ ë³€ê²½</span>
                        <svg id="theme-icon-light" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="theme-icon-dark" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
            
                    <div class="relative">
                        <button id="user-menu-button" type="button" class="flex h-8 w-8 items-center justify-center rounded-full bg-white/80 dark:bg-gray-800/80 text-gray-500 dark:text-gray-400 ring-1 ring-gray-900/5 dark:ring-white/10 transition hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none" aria-expanded="false" aria-haspopup="true">
                            <span class="sr-only">ì‚¬ìš©ì ë©”ë‰´ ì—´ê¸°</span>
                            <img class="h-8 w-8 rounded-full" id="user-menu-img" alt="í”„ë¡œí•„">
                        </button>
                        <div id="user-menu-dropdown" class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
                            <div class="border-b border-gray-200 dark:border-gray-700 px-4 py-3">
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="user-menu-name"></p>
                                <p class="truncate text-xs text-gray-500 dark:text-gray-400" id="user-menu-email"></p>
                            </div>
                            <div class="py-1" role="none">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" tabindex="-1">ë¡œê·¸ì•„ì›ƒ</a>
                            </div>
                        </div>
                    </div>
            
                </div>
            </div>

                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 md:text-4xl" title="Crafted by team.SP">[ë””ì§€í„¸í¼ìŠ¤íŠ¸] ë¯¸ë””ì–´ POC ë¦¬ìŠ¤íŠ¸</h1>
                <p class="mt-2 text-gray-500 dark:text-gray-400">ë§¤ì²´ëª…ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì—¬ ë‹´ë‹¹ì ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                <p id="last-updated-timestamp" class="mt-1 text-xs text-gray-400 dark:text-gray-500">ì—…ë°ì´íŠ¸ ì •ë³´ ë¡œë”© ì¤‘...</p>
                </header>

             <div id="patch-notes-section" class="mb-6 rounded-lg bg-gray-50 p-3 shadow-sm dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/60">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-2.036 9.284-5.117M15.18 3a3.001 3.001 0 00-2.18.879M15.879 21a3.001 3.001 0 002.18-.879" />
                    </svg>
                    <h3 class="ml-2 text-sm font-semibold text-gray-700 dark:text-gray-300">Patch note</h3>
                    <button id="edit-patch-notes-button" class="ml-auto hidden text-xs font-semibold text-blue-600 hover:underline dark:text-blue-400">ìˆ˜ì •</button>
                </div>
                <div id="patch-notes-view" class="mt-2 border-t border-gray-200 dark:border-gray-700 pt-2">
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400" id="patch-date">ë¡œë”© ì¤‘...</p>
                    <p class="mt-1 whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300" id="patch-content">ë¡œë”© ì¤‘...</p>
                </div>
                <div id="patch-notes-edit" class="hidden mt-2 border-t border-gray-200 dark:border-gray-700 pt-2">
                    <div class="mb-2">
                        <label for="patch-date-input" class="text-xs font-medium text-gray-500 dark:text-gray-400">ë‚ ì§œ</label>
                        <input type="text" id="patch-date-input" class="edit-input mt-1" placeholder="YYYY-MM-DD">
                    </div>
                    <div>
                        <label for="patch-content-input" class="text-xs font-medium text-gray-500 dark:text-gray-400">ë‚´ìš©</label>
                        <textarea id="patch-content-input" class="edit-input mt-1" rows="3" placeholder="ì—…ë°ì´íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2 mt-2">
                        <button id="cancel-patch-notes-button" class="px-3 py-1 text-sm rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">ì·¨ì†Œ</button>
                        <button id="save-patch-notes-button" class="px-3 py-1 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">ì €ì¥</button>
                    </div>
                </div>
            </div>
            <main>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-6 transition-colors duration-300">
                            <div class="mb-4">
                                <label for="search-box" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">ë§¤ì²´ëª…/ë‹´ë‹¹ì ê²€ìƒ‰</label>
                                <input type="text" id="search-box" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...">
                                
                                <p id="search-suggestion" class="hidden mt-2 text-sm text-gray-500 dark:text-gray-400"></p>
            
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì¤‘ë³µ ê°€ëŠ¥)</label>
                                <div id="category-tags-container" class="flex flex-wrap gap-2">
                                </div>
                            </div>
                        </div>

                <div id="add-new-button-wrapper" class="mb-6 text-right hidden space-x-2">
                    <button id="add-new-card-button" class="bg-blue-600 text-white font-bold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md inline-flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        ì‹ ê·œ ì¶”ê°€
                    </button>

                    <a id="request-edit-button" href="https://docs.google.com/spreadsheets/d/1PX7vIIGh5dlIguyhhNJ20kz8fbYOVJgGuEWOf2tAVWA/edit?gid=0#gid=0" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white font-bold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md inline-flex items-center hidden">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        ë§¤ì²´ ì •ë³´ ë“±ë¡/ìˆ˜ì • ìš”ì²­
                    </a>
                </div>

                <div id="media-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
                
                <div id="no-results" class="text-center py-16 px-6 bg-white dark:bg-gray-800 rounded-xl shadow-md hidden transition-colors duration-300">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-800 dark:text-gray-200">ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Firebaseì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜, ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>

                <div id="copy-all-container" class="mt-8 text-center hidden">
                    <button id="copy-all-button" class="bg-green-600 text-white font-bold text-sm py-2.5 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors shadow-lg">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        ê²€ìƒ‰ ê²°ê³¼ ë³µì‚¬(paste to Excel)
                    </button>
                </div>
            </main>

            <footer class="text-center mt-12 py-4 border-t border-gray-200 dark:border-gray-700 transition-colors duration-300">
                 <div id="admin-upload-section" class="mb-2 hidden">
                       <label for="excel-upload" class="text-xs text-gray-500 dark:text-gray-400 underline cursor-pointer hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                           ë°ì´í„°íŒŒì¼ ê´€ë¦¬(SPíŒ€)
                       </label>
                       <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv">
                       <span id="file-name" class="ml-2 text-xs text-gray-500"></span>
                 </div>
                 <div>
                       <p class="text-xs text-gray-400 dark:text-gray-500">copyright Â© digitalFirst All Right Reserved.</p>
                 </div>
            </footer>
        </div>

        <div class="fixed bottom-12 right-6 flex flex-col gap-2 z-40">
            <button id="scroll-to-top" title="ë§¨ ìœ„ë¡œ" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-opacity opacity-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
            </button>
            <button id="scroll-to-bottom" title="ë§¨ ì•„ë˜ë¡œ" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>

<div class="scrolling-banner-container bg-red-100/50 text-red-600 dark:bg-red-900/50 dark:text-red-300 fixed bottom-0 left-0 z-30">
            <div class="scrolling-banner-content py-1 text-xs font-semibold">
                <span>ë””ì§€í„¸í¼ìŠ¤íŠ¸ ë‚´ë¶€ ë°°í¬ ìë£Œì…ë‹ˆë‹¤. URLì™¸ë¶€ ê³µìœ  ê¸ˆì§€.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');

            let width = window.innerWidth;
            let height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;

            // ëˆˆì†¡ì´ ê°œìˆ˜ (ëª¨ë°”ì¼ì€ ì ê²Œ, PCëŠ” ë§ê²Œ)
            const maxSnowflakes = window.innerWidth < 768 ? 50 : 100;
            const snowflakes = [];

            // ìš©ì‚°êµ¬ ì¢Œí‘œ (ë””ì§€í„¸í¼ìŠ¤íŠ¸ ê·¼ì²˜)
            const LAT = 37.5326;
            const LNG = 126.9900;
            
            // â˜… ì¤‘ìš”: í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” trueë¡œ ë³€ê²½, ë°°í¬í•  ë•ŒëŠ” falseë¡œ ì„¤ì •í•˜ì„¸ìš”!
            const FORCE_SNOW_TEST = false; 

            class Snowflake {
                constructor() {
                    this.reset();
                }

                reset() {
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.radius = Math.random() * 2 + 1; // ëˆˆ í¬ê¸°
                    this.speed = Math.random() * 1 + 0.5; // ì†ë„
                    this.wind = Math.random() * 0.5 - 0.25; // ë°”ëŒ
                    this.opacity = Math.random() * 0.5 + 0.3; // íˆ¬ëª…ë„
                }

                update() {
                    this.y += this.speed;
                    this.x += this.wind;

                    if (this.y > height) {
                        this.y = -10;
                        this.x = Math.random() * width;
                    }
                    if (this.x > width) this.x = 0;
                    if (this.x < 0) this.x = width;
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    ctx.fill();
                    ctx.closePath();
                }
            }

            function initSnow() {
                for (let i = 0; i < maxSnowflakes; i++) {
                    snowflakes.push(new Snowflake());
                }
            }

            function animateSnow() {
                ctx.clearRect(0, 0, width, height);
                snowflakes.forEach(flake => {
                    flake.update();
                    flake.draw();
                });
                requestAnimationFrame(animateSnow);
            }

            // [í•µì‹¬ ê¸°ëŠ¥] Open-Meteo APIë¡œ ë‚ ì”¨ ì²´í¬
            async function checkWeatherAndStart() {
                // í…ŒìŠ¤íŠ¸ ëª¨ë“œì¼ ê²½ìš° ë¬´ì¡°ê±´ ëˆˆ ë‚´ë¦¼
                if (FORCE_SNOW_TEST) {
                    console.log("ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ê°•ì œë¡œ ëˆˆì„ ë‚´ë¦¬ê²Œ í•©ë‹ˆë‹¤.");
                    initSnow();
                    animateSnow();
                    return;
                }

                try {
                    // ìš©ì‚°êµ¬ í˜„ì¬ ë‚ ì”¨ ìš”ì²­
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LNG}&current_weather=true`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    // WMO ê¸°ìƒ ì½”ë“œ (ëˆˆ ê´€ë ¨ ì½”ë“œë“¤: 71, 73, 75, 77, 85, 86)
                    const snowCodes = [71, 73, 75, 77, 85, 86]; 
                    const currentWeatherCode = data.current_weather.weathercode;

                    console.log(`ğŸ“ ìš©ì‚°êµ¬ í˜„ì¬ ë‚ ì”¨ ì½”ë“œ: ${currentWeatherCode}`);

                    if (snowCodes.includes(currentWeatherCode)) {
                        console.log("â˜ƒï¸ ì™€! ì§€ê¸ˆ ìš©ì‚°êµ¬ì— ëˆˆì´ ì˜¤ë„¤ìš”. ëˆˆ íš¨ê³¼ë¥¼ ì¼­ë‹ˆë‹¤.");
                        initSnow();
                        animateSnow();
                    } else {
                        console.log("â˜€ï¸ ì§€ê¸ˆì€ ëˆˆì´ ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤. (ëˆˆ íš¨ê³¼ êº¼ì§)");
                        ctx.clearRect(0, 0, width, height);
                    }

                } catch (error) {
                    console.error("ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                }
            }

            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
            });

            // ë‚ ì”¨ ì²´í¬ ë° ì‹œì‘
            checkWeatherAndStart();
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, updateDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            // --- ì „ì—­ ë³€ìˆ˜ ---
            let mediaData = [];
            let currentFilteredData = [];
            let db, auth;
            let mediaCollectionRef;
            let isAdmin = false;
            const ALLOWED_DOMAIN = "dfirst-inc.com";
            const ADMIN_EMAILS = ["digitalfirst.sp@gmail.com", "simpson0270@gmail.com"];

            // --- DOM Element ì°¸ì¡° ---
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const loginButton = document.getElementById('login-button');
            const excelUpload = document.getElementById('excel-upload');
            const fileNameSpan = document.getElementById('file-name');
            const searchBox = document.getElementById('search-box');
            const categoryTagsContainer = document.getElementById('category-tags-container');
            const mediaList = document.getElementById('media-list');
            const copyAllButton = document.getElementById('copy-all-button');
            const copyAllContainer = document.getElementById('copy-all-container');
            const addNewCardButtonWrapper = document.getElementById('add-new-button-wrapper');
            const addNewCardButton = document.getElementById('add-new-card-button');
            const scrollTopBtn = document.getElementById('scroll-to-top');
            const scrollBottomBtn = document.getElementById('scroll-to-bottom');
            const noResults = document.getElementById('no-results');
            const userMenuContainer = document.getElementById('user-menu-container');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            const logoutButton = document.getElementById('logout-button');
            const adminUploadSection = document.getElementById('admin-upload-section');
            const requestEditButton = document.getElementById('request-edit-button'); 
            const patchNotesView = document.getElementById('patch-notes-view');
            const patchNotesEdit = document.getElementById('patch-notes-edit');
            const editPatchNotesButton = document.getElementById('edit-patch-notes-button');
            const cancelPatchNotesButton = document.getElementById('cancel-patch-notes-button');
            const savePatchNotesButton = document.getElementById('save-patch-notes-button');
            const patchDate = document.getElementById('patch-date');
            const patchContent = document.getElementById('patch-content');
            const patchDateInput = document.getElementById('patch-date-input');
            const patchContentInput = document.getElementById('patch-content-input');
            const searchSuggestion = document.getElementById('search-suggestion')
            // ===== ê¸°ëŠ¥ 1 ì¶”ê°€ ì‹œì‘ =====
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            // ===== ê¸°ëŠ¥ 1 ì¶”ê°€ ì¢…ë£Œ =====

            // ===== ê¸°ëŠ¥ 2 ì¶”ê°€ ì‹œì‘ =====
            const lastUpdatedTimestampEl = document.getElementById('last-updated-timestamp');
            // ===== ê¸°ëŠ¥ 2 ì¶”ê°€ ì¢…ë£Œ =====
            
            // --- í•¨ìˆ˜ ì„ ì–¸ ---
            function engToKor(text) {
                const keyMap = {
                    'q': 'ã…‚', 'w': 'ã…ˆ', 'e': 'ã„·', 'r': 'ã„±', 't': 'ã……', 'y': 'ã…›', 'u': 'ã…•', 'i': 'ã…‘', 'o': 'ã…', 'p': 'ã…”',
                    'a': 'ã…', 's': 'ã„´', 'd': 'ã…‡', 'f': 'ã„¹', 'g': 'ã…', 'h': 'ã…—', 'j': 'ã…“', 'k': 'ã…', 'l': 'ã…£',
                    'z': 'ã…‹', 'x': 'ã…Œ', 'c': 'ã…Š', 'v': 'ã…', 'b': 'ã… ', 'n': 'ã…œ', 'm': 'ã…¡',
                    'Q': 'ã…ƒ', 'W': 'ã…‰', 'E': 'ã„¸', 'R': 'ã„²', 'T': 'ã…†', 'O': 'ã…’', 'P': 'ã…–'
                };
                return text.split('').map(char => keyMap[char] || char);
            }

            // âœ… ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • ì™„ë£Œ (ì—ëŸ¬ ë°©ì§€ ë²„ì „)
            function initializeScrollingBanners() {
                const banners = document.querySelectorAll('.scrolling-banner-container');
                
                banners.forEach(banner => {
                    // í™”ë©´ì— ë³´ì´ì§€ ì•ŠëŠ” ìš”ì†Œ(display: none)ë¼ë©´ ê³„ì‚°í•˜ì§€ ì•Šê³  ì¢…ë£Œ
                    if (banner.offsetParent === null) return;

                    const content = banner.querySelector('.scrolling-banner-content');
                    const templateSpan = content ? content.querySelector('span') : null;
            
                    if (!content || !templateSpan) return;
            
                    let attempts = 0;
                    const maxAttempts = 15;
            
                    function setupAnimation() {
                        const bannerWidth = banner.offsetWidth;
                        const spanWidth = templateSpan.offsetWidth;
            
                        // ë„ˆë¹„ê°€ 0ì´ë©´(ì•„ì§ ë Œë”ë§ ì•ˆë¨) ì¬ì‹œë„
                        if ((bannerWidth === 0 || spanWidth === 0) && attempts < maxAttempts) {
                            attempts++;
                            requestAnimationFrame(setupAnimation);
                            return;
                        }
            
                        // ì¬ì‹œë„ í›„ì—ë„ 0ì´ë©´ ì¡°ìš©íˆ ì¢…ë£Œ (ì—ëŸ¬ ë¡œê·¸ ì œê±°)
                        if (bannerWidth === 0 || spanWidth === 0) {
                            return; 
                        }
            
                        const originalSpanHTML = templateSpan.outerHTML;
                        const spansToFill = Math.ceil(bannerWidth / spanWidth) + 1;
                        const totalSpans = spansToFill * 2;
                        
                        let newHTML = '';
                        for (let i = 0; i < totalSpans; i++) {
                            newHTML += originalSpanHTML;
                        }
                        content.innerHTML = newHTML;
                        
                        const scrollWidth = spansToFill * spanWidth;
                        content.style.setProperty('--scroll-width', `-${scrollWidth}px`);
                        
                        content.classList.add('animate');
                    }
            
                    setupAnimation();
                });
            }
            
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `${bgColor} text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg toast-notification opacity-0 transform translate-y-2`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.classList.remove('opacity-0', 'translate-y-2'); toast.classList.add('opacity-100', 'transform-none'); }, 10);
                setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => { toast.remove(); }, 500); }, 2000);
            }

            function generateCardView(item, isAdminUser) {
                const categoryTagsHtml = (item.ì¹´í…Œê³ ë¦¬ || []).map(cat => `<span class="text-xs font-semibold text-blue-800 bg-blue-100 dark:text-gray-200 dark:bg-gray-600 px-2 py-1 rounded-full">${cat}</span>`).join('');
                
                const adminButtonsHtml = isAdminUser ? `
                    <div class="flex flex-col items-end space-y-1 flex-shrink-0">
                        <button data-action="edit" data-id="${item.id}" class="text-xs text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400">ìˆ˜ì •</button>
                        <button data-action="delete" data-id="${item.id}" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400">ì‚­ì œ</button>
                    </div>` : '';

                let infoHtml = '';
                const createRow = (label, value, clipValue) => {
                    if (!value) return '';
                    const copyButton = clipValue ? `<button class="copy-button ml-auto shrink-0" data-clipboard="${clipValue}" aria-label="${label} ë³µì‚¬"><svg class="w-5 h-5 text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>` : '';
                    return `<div class="flex items-center gap-2"><span class="font-semibold text-gray-500 dark:text-gray-400 w-20 shrink-0">${label}</span><div class="hover-scroll-container flex-grow min-w-0"><span class="truncate block">${value}</span></div>${copyButton}</div>`;
                };
                const contactPerson = item.ë‹´ë‹¹ì ? `${item.ë‹´ë‹¹ì}${item.ì§ì±… ? ` / ${item.ì§ì±…}` : ''}` : '';
                infoHtml += createRow('ë‹´ë‹¹ì', contactPerson);
                infoHtml += createRow('ì´ë©”ì¼', item.ì´ë©”ì¼, item.ì´ë©”ì¼);
                infoHtml += createRow('íŒ€ë©”ì¼', item.íŒ€ë©”ì¼, item.íŒ€ë©”ì¼);
                infoHtml += createRow('ì—°ë½ì²˜', item.ì—°ë½ì²˜, item.ì—°ë½ì²˜);
                infoHtml += createRow('íŒë§¤ ëŒ€í–‰ì‚¬', item['íŒë§¤ ëŒ€í–‰ì‚¬'], item['íŒë§¤ ëŒ€í–‰ì‚¬']);
                const introButtonHtml = item['ì†Œê°œì„œURL'] ? `<a href="${item['ì†Œê°œì„œURL']}" target="_blank" rel="noopener noreferrer" class="w-full text-center block bg-blue-600 text-white font-semibold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 transition-colors">ì†Œê°œì„œ ë‹¤ìš´ë¡œë“œ</a>` : `<button class="w-full text-center block bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-semibold text-sm py-2 px-4 rounded-lg cursor-not-allowed" disabled>ì†Œê°œì„œ ì—†ìŒ</button>`;

                let newTagHtml = '';
                // 1. ì‹ ê·œ ì—¬ë¶€ í™•ì¸
                if (item.createdAt && item.createdAt.toDate && isWithinBusinessDays(item.createdAt.toDate(), 7)) {
                    newTagHtml = '<span class="ml-2 text-sm font-bold text-green-500 animate-pulse">[ì‹ ê·œ]</span>';
                } 
                // 2. ì—…ë°ì´íŠ¸ ì—¬ë¶€ í™•ì¸ (ì‹ ê·œê°€ ì•„ë‹ ë•Œë§Œ ì²´í¬)
                else if (item.updatedAt && item.updatedAt.toDate && isWithinBusinessDays(item.updatedAt.toDate(), 7)) {
                    newTagHtml = '<span class="ml-2 text-sm font-bold text-red-500 animate-pulse">[ì—…ë°ì´íŠ¸]</span>';
                }

                return `<div class="flex justify-between items-start gap-2 mb-4">
                            <div class="flex items-center">
                                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 break-words" title="${item.ë§¤ì²´ëª… || ''}">${item.ë§¤ì²´ëª… || ''}</h2>
                                ${newTagHtml}
                            </div>
                            ${adminButtonsHtml}
                        </div>
                        <div class="flex-grow">
                            <div class="flex flex-wrap gap-2 mb-4">${categoryTagsHtml}</div>
                            <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">${infoHtml}</div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">${introButtonHtml}</div>`;
            }

            function generateCardEditView(item) {
                const createInput = (name, label, value) => `<div class="mb-2"><label class="block text-xs font-medium text-gray-500 dark:text-gray-400">${label}</label><input type="text" name="${name}" value="${value || ''}" class="edit-input"></div>`;
                return `<form data-id="${item.id || ''}">${createInput('ë§¤ì²´ëª…', 'ë§¤ì²´ëª…', item.ë§¤ì²´ëª…)}${createInput('ì¹´í…Œê³ ë¦¬', 'ì¹´í…Œê³ ë¦¬ (ì‰¼í‘œë¡œ êµ¬ë¶„)', (item.ì¹´í…Œê³ ë¦¬ || []).join(', '))}${createInput('ë‹´ë‹¹ì', 'ë‹´ë‹¹ì', item.ë‹´ë‹¹ì)}${createInput('ì§ì±…', 'ì§ì±…', item.ì§ì±…)}${createInput('ì´ë©”ì¼', 'ì´ë©”ì¼', item.ì´ë©”ì¼)}${createInput('íŒ€ë©”ì¼', 'íŒ€ë©”ì¼', item.íŒ€ë©”ì¼)}${createInput('ì—°ë½ì²˜', 'ì—°ë½ì²˜', item.ì—°ë½ì²˜)}${createInput('íŒë§¤ ëŒ€í–‰ì‚¬', 'íŒë§¤ ëŒ€í–‰ì‚¬', item['íŒë§¤ ëŒ€í–‰ì‚¬'])}${createInput('ì†Œê°œì„œURL', 'ì†Œê°œì„œURL', item['ì†Œê°œì„œURL'])}<div class="flex justify-end gap-2 mt-4"><button type="button" data-action="cancel" data-id="${item.id || ''}" class="px-3 py-1 text-sm rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">ì·¨ì†Œ</button><button type="button" data-action="save" data-id="${item.id || ''}" class="px-3 py-1 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">ì €ì¥</button></div></form>`;
            }
            
            function renderMedia(data) {
                const newCard = document.querySelector('[data-is-new="true"]');
                mediaList.innerHTML = '';
                if (newCard) {
                    mediaList.appendChild(newCard);
                }
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.id = `card-${item.id}`;
                    card.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 flex flex-col transition-transform transform hover:-translate-y-1 transition-colors duration-300';
                                
                    card.innerHTML = generateCardView(item, isAdmin);
                    mediaList.appendChild(card);
                });
                const hasContentToShow = mediaList.hasChildNodes();
                noResults.classList.toggle('hidden', hasContentToShow);
                copyAllContainer.classList.toggle('hidden', !hasContentToShow || !!newCard);
            }
                    
            function filterAndRender() {
                const rawTerms = searchBox.value.trim().split(',');
                const processedTerms = [];
                let typoFound = false;
            
                rawTerms.forEach(term => {
                    const singleTerm = term.trim();
                    if (!singleTerm) return;
            
                    // 1. ì–´ë–¤ ê²½ìš°ë“  ì›ë˜ ì…ë ¥í•œ ê°’ì„ ë¨¼ì € í›„ë³´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
                    processedTerms.push(singleTerm);
            
                    // 2. í•œ/ì˜ ë³€í™˜ì„ ì‹œë„í•©ë‹ˆë‹¤.
                    const converted = singleTerm.replace(/[a-zA-Z]+/g, (match) => {
                        if (typeof Hangul === 'undefined') return match;
                        const jamoArray = engToKor(match);
                        return Hangul.assemble(jamoArray);
                    });
            
                    // 3. ë§Œì•½ ë³€í™˜ëœ ê²°ê³¼ê°€ ì›ë³¸ê³¼ ë‹¤ë¥´ë‹¤ë©´, ë³€í™˜ëœ ê°’ë„ í›„ë³´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
                    if (converted && converted !== singleTerm) {
                        processedTerms.push(converted);
                        typoFound = true;
                    }
                });
            
                if (typoFound) {
                    // ë³€í™˜ëœ ê²€ìƒ‰ì–´ ì¤‘, ì™„ì„±ëœ í•œê¸€ì´ í¬í•¨ëœ ê²ƒë§Œ í•„í„°ë§
                    const suggestionCandidates = processedTerms.filter(t => /[ê°€-í£]/.test(t));
                
                    if (suggestionCandidates.length > 0) {
                        const suggestionText = suggestionCandidates.join(', ');
                        searchSuggestion.textContent = `í˜¹ì‹œ '${suggestionText}'ì„(ë¥¼) ì…ë ¥í•˜ì…¨ë‚˜ìš”?`;
                        searchSuggestion.classList.remove('hidden');
                    } else {
                        // 'SOOP' -> 'Sã…ã…ã…”' ì²˜ëŸ¼ ì™„ì„±ëœ í•œê¸€ì´ ì—†ìœ¼ë©´ ì¶”ì²œ ì•ˆí•¨
                        searchSuggestion.classList.add('hidden');
                    }
                } else {
                    searchSuggestion.classList.add('hidden');
                    searchSuggestion.textContent = '';
                }
                
                const searchTerms = processedTerms
                    .map(term => term.toLowerCase().replace(/\s/g, ''))
                    .filter(term => term.length > 0);
                const selectedCategoryNodes = categoryTagsContainer.querySelectorAll('.bg-blue-600, .dark\\:bg-blue-500');
                const selectedCategories = Array.from(selectedCategoryNodes).map(node => node.dataset.category);
                const filteredData = mediaData.filter(item => {
                    const matchesSearch = searchTerms.length === 0 ? true : searchTerms.some(term => {
                        const mediaName = (item.ë§¤ì²´ëª… || '').toLowerCase().replace(/\s/g, '');
                        const pocName = (item.ë‹´ë‹¹ì || '').toLowerCase().replace(/\s/g, '');
                        const agencyName = (item['íŒë§¤ ëŒ€í–‰ì‚¬'] || '').toLowerCase().replace(/\s/g, '');
                        return mediaName.includes(term) || pocName.includes(term) || agencyName.includes(term);
                    });
                    const matchesCategory = selectedCategories.length === 0 ? true : selectedCategories.some(cat => (item.ì¹´í…Œê³ ë¦¬ || []).includes(cat));
                    return matchesSearch && matchesCategory;
                });
                currentFilteredData = filteredData;
                renderMedia(filteredData);
            }          
            function initializeUIWithData(data) {
                mediaData = data;
                populateCategories();
                updateSearchPlaceholder();
                filterAndRender();
            }
            
            function processExcelData(rawData) {
                return rawData.map(row => {
                    const safeRow = (typeof row === 'object' && row !== null) ? row : {};
                    return { ...safeRow, ì¹´í…Œê³ ë¦¬: (safeRow.ì¹´í…Œê³ ë¦¬ && typeof safeRow.ì¹´í…Œê³ ë¦¬ === 'string') ? safeRow.ì¹´í…Œê³ ë¦¬.split(',').map(cat => cat.trim()).filter(Boolean) : (Array.isArray(safeRow.ì¹´í…Œê³ ë¦¬) ? safeRow.ì¹´í…Œê³ ë¦¬ : []) };
                });
            }

            function updateSearchPlaceholder() {
                searchBox.placeholder = 'ì˜ˆ: ë””ì§€í„¸í¼ìŠ¤íŠ¸, ì¡°ì„±ì£¼...'; 
            }
            
            function populateCategories() {
                const activeCategories = new Set(Array.from(categoryTagsContainer.querySelectorAll('.bg-blue-600, .dark\\:bg-blue-500')).map(tag => tag.dataset.category));
                categoryTagsContainer.innerHTML = '';
                const allCategories = new Set(mediaData.flatMap(item => item.ì¹´í…Œê³ ë¦¬).filter(Boolean));
                const sortedCategories = [...allCategories].sort((a,b) => a.localeCompare(b, 'ko'));
                sortedCategories.forEach(category => {
                    const button = document.createElement('button');
                    if (activeCategories.has(category)) {
                        button.className = 'category-tag px-3 py-1.5 rounded-full text-sm font-semibold bg-blue-600 dark:bg-blue-500 text-white dark:text-white';
                    } else {
                        button.className = 'category-tag px-3 py-1.5 rounded-full text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600';
                    }
                    button.textContent = category;
                    button.dataset.category = category;
                    categoryTagsContainer.appendChild(button);
                });
            }

            function copyTextToClipboard(textToCopy) {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                let success = false;
                try { success = document.execCommand('copy'); } catch (err) { success = false; }
                document.body.removeChild(textArea);
                return success;
            }
            
            function isWithinBusinessDays(creationDate, businessDayLimit) {
                if (!creationDate || !(creationDate instanceof Date)) return false;
            
                const today = new Date();
                today.setHours(23, 59, 59, 999);
            
                if (creationDate > today) return false;
            
                let businessDaysPassed = 0;
                let currentDate = new Date(creationDate);
            
                while (currentDate <= today) {
                    const day = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
                    if (day !== 0 && day !== 6) {
                        businessDaysPassed++;
                    }
                    if (businessDaysPassed > businessDayLimit) {
                        return false;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return true;
            }

            // ===== ê¸°ëŠ¥ 2 ì¶”ê°€ ì‹œì‘ =====
            // ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„ì„ Firestoreì— ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜
            async function updateLastUpdatedTimestamp() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // ë°ì´í„°ì™€ ë³„ë„ì˜ ê²½ë¡œì— ë©”íƒ€ë°ì´í„°ë¥¼ ì €ì¥
                const metaRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'lastUpdated');
                try {
                    await setDoc(metaRef, { timestamp: new Date() });
                } catch (error) {
                    console.error("ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡ ì‹¤íŒ¨:", error);
                }
            }
            // ===== ê¸°ëŠ¥ 2 ì¶”ê°€ ì¢…ë£Œ =====

            async function uploadDataToFirebase(dataToUpload) {
                showToast('ë°ì´í„°ë¥¼ Firebaseì— ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...', 'success');
                try {
                    const existingDocs = await getDocs(mediaCollectionRef);
                    const deleteBatch = writeBatch(db);
                    existingDocs.forEach(doc => { deleteBatch.delete(doc.ref); });
                    await deleteBatch.commit();
                    const addBatch = writeBatch(db);
                    dataToUpload.forEach(item => {
                        const docRef = doc(mediaCollectionRef);
                        addBatch.set(docRef, item);
                    });
                    await addBatch.commit();
                    
                    // ===== ê¸°ëŠ¥ 2 ì—°ë™ ì‹œì‘ =====
                    await updateLastUpdatedTimestamp(); // ì—…ë¡œë“œ ì„±ê³µ í›„ ì‹œê°„ ê¸°ë¡
                    // ===== ê¸°ëŠ¥ 2 ì—°ë™ ì¢…ë£Œ =====

                    showToast(`${dataToUpload.length}ê°œì˜ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                    mediaData = [];
                    filterAndRender();
                } catch (error) {
                    console.error("Firebase ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                    showToast("Firebaseì— ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                }
            }

            let firestoreUnsubscribe = null;
            function initializeFirestoreListener() {
                if (firestoreUnsubscribe) firestoreUnsubscribe(); 
                
                firestoreUnsubscribe = onSnapshot(mediaCollectionRef, (snapshot) => {
                    if (snapshot.empty || snapshot.docChanges().length === 0) {
                        return;
                    }
                    snapshot.docChanges().forEach((change) => {
                        const changedData = { id: change.doc.id, ...change.doc.data() };
                        if (change.type === "added") {
                            const isDuplicate = mediaData.some(item => item.id === change.doc.id);
                            if (!isDuplicate) {
                                mediaData.push(changedData);
                            }
                        }
                        if (change.type === "modified") {
                            const index = mediaData.findIndex(item => item.id === change.doc.id);
                            if (index > -1) {
                                mediaData[index] = changedData;
                            }
                        }
                        if (change.type === "removed") {
                            mediaData = mediaData.filter(item => item.id !== change.doc.id);
                        }
                    });

                    mediaData.sort((a, b) => {
                        // ì‹ ê·œ ì—¬ë¶€ ì²´í¬ (7ì˜ì—…ì¼)
                        const isANew = a.createdAt && a.createdAt.toDate && isWithinBusinessDays(a.createdAt.toDate(), 7);
                        const isBNew = b.createdAt && b.createdAt.toDate && isWithinBusinessDays(b.createdAt.toDate(), 7);
                        
                        // ì—…ë°ì´íŠ¸ ì—¬ë¶€ ì²´í¬ (7ì˜ì—…ì¼)
                        const isAUpdated = a.updatedAt && a.updatedAt.toDate && isWithinBusinessDays(a.updatedAt.toDate(), 7);
                        const isBUpdated = b.updatedAt && b.updatedAt.toDate && isWithinBusinessDays(b.updatedAt.toDate(), 7);

                        // 1ìˆœìœ„: [ì‹ ê·œ]ê°€ ìµœìƒë‹¨
                        if (isANew && !isBNew) return -1;
                        if (!isANew && isBNew) return 1;

                        // 2ìˆœìœ„: ë‘˜ ë‹¤ ì‹ ê·œê°€ ì•„ë‹ˆê±°ë‚˜, ë‘˜ ë‹¤ ì‹ ê·œë¼ë©´ -> [ì—…ë°ì´íŠ¸]ê°€ ê·¸ ë‹¤ìŒ ìƒë‹¨
                        // (ë‹¨, ë‘˜ë‹¤ ì‹ ê·œì¸ ê²½ìš°ëŠ” ì´ë¦„ìˆœìœ¼ë¡œ ê°€ê¸° ìœ„í•´ ì—¬ê¸°ì„œ ì²˜ë¦¬ ì•ˆí•¨, ì‹ ê·œê°€ ì•„ë‹Œ ê·¸ë£¹ ë‚´ì—ì„œë§Œ ì—…ë°ì´íŠ¸ ë¹„êµ)
                        if (!isANew && !isBNew) {
                            if (isAUpdated && !isBUpdated) return -1;
                            if (!isAUpdated && isBUpdated) return 1;
                        }

                        // 3ìˆœìœ„: ê·¸ ì™¸ëŠ” ë§¤ì²´ëª… ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
                        return (a.ë§¤ì²´ëª… || '').localeCompare(b.ë§¤ì²´ëª… || '', 'ko');
                    });

                    filterAndRender(); 
                    populateCategories();

                }, (error) => {
                    console.error("ì‹¤ì‹œê°„ ë°ì´í„° ê°ì§€ ì˜¤ë¥˜: ", error);
                    showToast("ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                });
            }
            
            function setupUserInfo(user) {
                const userImg = document.getElementById('user-menu-img');
                const userName = document.getElementById('user-menu-name');
                const userEmail = document.getElementById('user-menu-email');

                if (user) {
                    userImg.src = user.photoURL || `https://placehold.co/32x32/e2e8f0/64748b?text=${(user.displayName || user.email)[0]}`;
                    userName.textContent = user.displayName || 'ì‚¬ìš©ì';
                    userEmail.textContent = user.email;
                }
            }

            function initializePatchNotesListener(isAdminUser) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const patchNoteRef = doc(db, `artifacts/${appId}/public/data/patchNotes`, 'latest');
            
                onSnapshot(patchNoteRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        patchDate.textContent = data.date || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                        patchContent.textContent = data.content || 'ì—…ë°ì´íŠ¸ ë‚´ìš© ì—†ìŒ';
            
                        if (isAdminUser) {
                            editPatchNotesButton.classList.remove('hidden');
                        }
                    } else {
                        patchDate.textContent = 'YYYY-MM-DD';
                        patchContent.textContent = 'ì•„ì§ ë“±ë¡ëœ Patch noteê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ê³§ ì—…ë°ì´íŠ¸í•  ì˜ˆì •ì…ë‹ˆë‹¤.';
                        if (isAdminUser) {
                            editPatchNotesButton.classList.remove('hidden');
                        }
                    }
                }, (error) => {
                    console.error("Patch note ì‹¤ì‹œê°„ ê°ì§€ ì˜¤ë¥˜:", error);
                    patchContent.textContent = 'Patch noteë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                });
            }
            
            // ===== ê¸°ëŠ¥ 2 ì¶”ê°€ ì‹œì‘ =====
            function initializeLastUpdatedListener() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const metaRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'lastUpdated');

                onSnapshot(metaRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Firestore Timestampë¥¼ JavaScript Date ê°ì²´ë¡œ ë³€í™˜
                        const date = data.timestamp.toDate();
                        
                        // ë‚ ì§œ í¬ë§·íŒ… (YYYY-MM-DD HH:mm:ss)
                        const pad = (num) => num.toString().padStart(2, '0');
                        const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
                        
                        lastUpdatedTimestampEl.textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${formattedDate}`;
                    } else {
                        lastUpdatedTimestampEl.textContent = 'ì—…ë°ì´íŠ¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                    }
                }, (error) => {
                    console.error("ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„ ê°ì§€ ì˜¤ë¥˜:", error);
                    lastUpdatedTimestampEl.textContent = 'ì—…ë°ì´íŠ¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
                });
            }
            // ===== ê¸°ëŠ¥ 2 ì¶”ê°€ ì¢…ë£Œ =====

            function handleEditPatchNotes() {
                patchDateInput.value = patchDate.textContent;
                patchContentInput.value = patchContent.textContent;
            
                patchNotesView.classList.add('hidden');
                patchNotesEdit.classList.remove('hidden');
            }
            
            function handleCancelPatchNotes() {
                patchNotesEdit.classList.add('hidden');
                patchNotesView.classList.remove('hidden');
            }
            
            async function handleSavePatchNotes() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const patchNoteRef = doc(db, `artifacts/${appId}/public/data/patchNotes`, 'latest');
                
                const newDate = patchDateInput.value;
                const newContent = patchContentInput.value;
            
                if (!newDate || !newContent) {
                    showToast("ë‚ ì§œì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                    return;
                }
            
                try {
                    await setDoc(patchNoteRef, {
                        date: newDate,
                        content: newContent
                    });
                    showToast("Patch noteê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                    handleCancelPatchNotes();
                } catch (error) {
                    console.error("Patch note ì €ì¥ ì˜¤ë¥˜:", error);
                    showToast("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            }    
            
            // --- ë©”ì¸ ì‹¤í–‰ ë¡œì§ ---
            async function main() {
                try {
                    const firebaseConfig = __firebase_config;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    mediaCollectionRef = collection(db, `artifacts/${appId}/public/data/mediaPocData`);

                    onAuthStateChanged(auth, (user) => {
                        if (!user) {
                            loginScreen.style.display = 'flex';
                            mainContent.style.display = 'none';
                            userMenuContainer.style.display = 'none';
                            addNewCardButtonWrapper.classList.add('hidden');
                            adminUploadSection.classList.add('hidden');
                            return;
                        }
                        
                        const isAuthorized = user.email.endsWith(`@${ALLOWED_DOMAIN}`) || ADMIN_EMAILS.includes(user.email);
                        isAdmin = ADMIN_EMAILS.includes(user.email);
                        
                        if (isAuthorized) {
                            loginScreen.style.display = 'none';
                            mainContent.style.display = 'block';

                            initializeScrollingBanners();
                            window.addEventListener('resize', initializeScrollingBanners);
                            
                            userMenuContainer.style.display = 'block';
                            setupUserInfo(user);
                            
                            // ===== ê¸°ëŠ¥ 1 ì—°ë™ ì‹œì‘ =====
                            updateThemeIcons(); // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ í…Œë§ˆì— ë§ëŠ” ì•„ì´ì½˜ í‘œì‹œ
                            // ===== ê¸°ëŠ¥ 1 ì—°ë™ ì¢…ë£Œ =====

                            addNewCardButtonWrapper.classList.remove('hidden');
                            if (isAdmin) {
                                addNewCardButton.classList.remove('hidden');
                                requestEditButton.classList.remove('hidden');
                                adminUploadSection.classList.remove('hidden');
                            } else {
                                 addNewCardButton.classList.add('hidden');
                                requestEditButton.classList.remove('hidden');
                                adminUploadSection.classList.add('hidden');
                            }

                            getDocs(mediaCollectionRef).then(querySnapshot => {
                                let initialData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                initialData.sort((a, b) => {
                                    const isANew = a.createdAt && a.createdAt.toDate && isWithinBusinessDays(a.createdAt.toDate(), 7);
                                    const isBNew = b.createdAt && b.createdAt.toDate && isWithinBusinessDays(b.createdAt.toDate(), 7);
                                    
                                    if (isANew && !isBNew) return -1; // aê°€ ì‹ ê·œë©´ ìœ„ë¡œ
                                    if (!isANew && isBNew) return 1;  // bê°€ ì‹ ê·œë©´ ìœ„ë¡œ
                                    
                                    // ë‘˜ ë‹¤ ì‹ ê·œì´ê±°ë‚˜ ë‘˜ ë‹¤ ì•„ë‹ ê²½ìš°, ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
                                    return (a.ë§¤ì²´ëª… || '').localeCompare(b.ë§¤ì²´ëª… || '', 'ko');
                                });
                                initializeUIWithData(initialData);
                                initializeFirestoreListener();
                                initializePatchNotesListener(isAdmin);
                                // ===== ê¸°ëŠ¥ 2 ì—°ë™ ì‹œì‘ =====
                                initializeLastUpdatedListener(); // ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
                                // ===== ê¸°ëŠ¥ 2 ì—°ë™ ì¢…ë£Œ =====
                            }).catch(error => {
                                console.error("ìµœì´ˆ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
                                showToast("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                            });    
                        } else {
                            showToast("í—ˆìš©ë˜ì§€ ì•Šì€ ê³„ì •ì…ë‹ˆë‹¤.", "error");
                            signOut(auth); 
                        }
                    });
                } catch (e) {
                    console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
                    showToast("Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.", "error");
                    loginScreen.innerHTML = `<div class="text-center text-red-500">Firebase ì—°ê²° ì‹¤íŒ¨! ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>`;
                    loginScreen.style.display = 'flex';
                }

                userMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('hidden');
                });
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    signOut(auth).catch(error => showToast("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨", "error"));
                });
                window.addEventListener('click', (e) => {
                    if (userMenuButton && userMenuDropdown && !userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                        userMenuDropdown.classList.add('hidden');
                    }
                });
            }
            
            loginButton.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                signInWithPopup(auth, provider).catch((error) => {
                    console.error("Google ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                    showToast("Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                });
            });
            
            addNewCardButton.addEventListener('click', () => {
                if (document.querySelector('[data-is-new="true"]')) {
                    showToast("ë¨¼ì € ì‘ì„± ì¤‘ì¸ ìƒˆ í•­ëª©ì„ ì €ì¥í•˜ê±°ë‚˜ ì·¨ì†Œí•´ì£¼ì„¸ìš”.", "error");
                    return;
                }
                const newItemData = { ë§¤ì²´ëª…: '', ì¹´í…Œê³ ë¦¬: [] };
                const tempCard = document.createElement('div');
                tempCard.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 flex flex-col';
                tempCard.dataset.isNew = 'true';
                tempCard.innerHTML = generateCardEditView(newItemData);
                mediaList.prepend(tempCard);
                tempCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                tempCard.querySelector('input[name="ë§¤ì²´ëª…"]')?.focus();
            });

            excelUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !db) { showToast("Firebaseê°€ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error"); return; };
                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        const processedData = processExcelData(jsonData);
            
                        // â–¼â–¼â–¼ ë°”ë¡œ ì´ ë¶€ë¶„ì´ ì¶”ê°€ëœ ì•ˆì „ì¥ì¹˜ì…ë‹ˆë‹¤! â–¼â–¼â–¼
                        
                        // 1. ì‚¬ìš©ìì—ê²Œ ìœ„í—˜í•œ ì‘ì—…ì„ì„ ì•Œë¦¬ê³  í™•ì¸ì„ ë°›ìŠµë‹ˆë‹¤.
                        if (confirm(`ì •ë§ë¡œ ê¸°ì¡´ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ${processedData.length}ê°œì˜ ìƒˆ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                            // 2. ì‚¬ìš©ìê°€ 'í™•ì¸'ì„ ëˆŒë €ì„ ë•Œë§Œ ì—…ë¡œë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
                            uploadDataToFirebase(processedData);
                        } else {
                            // 3. ì‚¬ìš©ìê°€ 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ë©´ ì‘ì—…ì„ ì¤‘ë‹¨í•˜ê³  ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                            showToast("ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                            e.target.value = ''; // íŒŒì¼ ì„ íƒì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                            fileNameSpan.textContent = '';
                        }
                        // â–²â–²â–² ì—¬ê¸°ê¹Œì§€ê°€ ìˆ˜ì •ëœ ë¶€ë¶„ì…ë‹ˆë‹¤. â–²â–²â–²
            
                    } catch (error) {
                        console.error("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                        showToast("íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "error");
                    }
                };
                reader.onerror = (error) => { console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", error); showToast("íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error"); };
                reader.readAsArrayBuffer(file);
            });

            categoryTagsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.category-tag');
                if (!target) return;
                target.classList.toggle('bg-blue-600');
                target.classList.toggle('dark:bg-blue-500');
                target.classList.toggle('text-white');
                target.classList.toggle('dark:text-white');
                target.classList.toggle('bg-gray-200');
                target.classList.toggle('dark:bg-gray-700');
                target.classList.toggle('text-gray-700');
                target.classList.toggle('dark:text-gray-300');
                filterAndRender();
            });

            let debounceTimer;
            searchBox.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(filterAndRender, 200); });
            
            mediaList.addEventListener('click', async function(e) {
                const button = e.target.closest('button');
                if (!button) return;
                const cardElement = button.closest('[id^="card-"], [data-is-new="true"]');
                if (!cardElement) return;
                if (button.classList.contains('copy-button')) {
                    const textToCopy = button.dataset.clipboard;
                    if (copyTextToClipboard(textToCopy)) {
                        showToast(`'${textToCopy}' ë³µì‚¬ ì™„ë£Œ!`);
                        button.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                        setTimeout(() => { button.innerHTML = `<svg class="w-5 h-5 text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`; }, 1500);
                    } else { showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'); }
                    return;
                }
                const action = button.dataset.action;
                const isNew = cardElement.dataset.isNew === 'true';
                const id = isNew ? null : cardElement.id.replace('card-', '');
                const item = isNew ? null : mediaData.find(item => item.id === id);
                if (!isNew && !item) return;
                const docRef = id ? doc(db, mediaCollectionRef.path, id) : null;
                if (action === 'edit') {
                    cardElement.innerHTML = generateCardEditView(item);
                } else if (action === 'delete') {
                    cardElement.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-4"><p class="text-sm text-gray-800 dark:text-gray-200 text-center font-semibold mb-4">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><div class="flex space-x-2"><button type="button" data-action="cancel-delete" data-id="${id}" class="px-3 py-1 text-sm rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">ì·¨ì†Œ</button><button type="button" data-action="confirm-delete" data-id="${id}" class="px-3 py-1 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">í™•ì¸</button></div></div>`;
                } else if (action === 'confirm-delete') {
                    if (!docRef) return;
                    try { 
                        await deleteDoc(docRef); 
                        await updateLastUpdatedTimestamp(); // ===== ê¸°ëŠ¥ 2 ì—°ë™ =====
                        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); 
                    } catch (error) { console.error("ì‚­ì œ ì˜¤ë¥˜: ", error); showToast("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error"); if(item) cardElement.innerHTML = generateCardView(item, isAdmin); }
                } else if (action === 'cancel-delete') { // 'cancel-delete' ì•¡ì…˜ ì²˜ë¦¬ ì¶”ê°€
                    if(item) cardElement.innerHTML = generateCardView(item, isAdmin);
                } else if (action === 'cancel') {
                    if (isNew) { cardElement.remove(); } else { cardElement.innerHTML = generateCardView(item, isAdmin); }
                } else if (action === 'save') {
                    const form = cardElement.querySelector('form');
                    const formData = new FormData(form);
                    const updatedItemData = {};

                    // í¼ ë°ì´í„° ìˆ˜ì§‘
                    for (let [key, value] of formData.entries()) {
                        if (key === 'ì¹´í…Œê³ ë¦¬') { 
                            updatedItemData[key] = value.split(',').map(v => v.trim()).filter(Boolean); 
                        } else { 
                            updatedItemData[key] = value.trim(); // ê³µë°± ì œê±° í›„ ì €ì¥
                        }
                    }

                    try {
                        if (isNew) {
                            updatedItemData.createdAt = new Date();
                            await addDoc(mediaCollectionRef, updatedItemData);
                            cardElement.remove();
                            await updateLastUpdatedTimestamp(); 
                            showToast('ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        } else {
                            if (!docRef) return;

                            // âœ¨ [í•µì‹¬ ìˆ˜ì •] ë³€ê²½ ì‚¬í•­ ê°ì§€ ë¡œì§ ì‹œì‘ âœ¨
                            let isChanged = false;
                            
                            // 1. í…ìŠ¤íŠ¸ í•„ë“œ ë¹„êµ
                            const textFields = ['ë§¤ì²´ëª…', 'ë‹´ë‹¹ì', 'ì§ì±…', 'ì´ë©”ì¼', 'íŒ€ë©”ì¼', 'ì—°ë½ì²˜', 'íŒë§¤ ëŒ€í–‰ì‚¬', 'ì†Œê°œì„œURL'];
                            for (const field of textFields) {
                                const originalVal = (item[field] || '').trim();
                                const newVal = (updatedItemData[field] || '');
                                if (originalVal !== newVal) {
                                    isChanged = true;
                                    break;
                                }
                            }

                            // 2. ì¹´í…Œê³ ë¦¬(ë°°ì—´) ë¹„êµ
                            if (!isChanged) {
                                const originalCats = (item.ì¹´í…Œê³ ë¦¬ || []).slice().sort().join(',');
                                const newCats = (updatedItemData.ì¹´í…Œê³ ë¦¬ || []).slice().sort().join(',');
                                if (originalCats !== newCats) {
                                    isChanged = true;
                                }
                            }

                            // 3. ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•Šê³  ë·° ëª¨ë“œë¡œ ë³µê·€
                            if (!isChanged) {
                                showToast('ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                                cardElement.innerHTML = generateCardView(item, isAdmin);
                                return; // í•¨ìˆ˜ ì¢…ë£Œ (DB ì—…ë°ì´íŠ¸ ì•ˆ í•¨)
                            }

                            // 4. ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡ ë° ì €ì¥
                            updatedItemData.updatedAt = new Date(); 
                            await updateDoc(docRef, updatedItemData);
                            await updateLastUpdatedTimestamp();
                            showToast('ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                            // âœ¨ [í•µì‹¬ ìˆ˜ì •] ë³€ê²½ ì‚¬í•­ ê°ì§€ ë¡œì§ ë âœ¨
                        }
                    } catch (error) {
                        console.error("ì €ì¥ ì˜¤ë¥˜: ", error);
                        showToast("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                    }
                }
            });
            copyAllButton.addEventListener('click', () => {
                if (currentFilteredData.length === 0) { showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                const header = "ë§¤ì²´ëª…\tì¹´í…Œê³ ë¦¬\të‹´ë‹¹ì\tì§ì±…\tì´ë©”ì¼\tíŒ€ë©”ì¼\tì—°ë½ì²˜\tíŒë§¤ ëŒ€í–‰ì‚¬\tì†Œê°œì„œURL";
                const rows = currentFilteredData.map(item => {
                    const categories = (item.ì¹´í…Œê³ ë¦¬ || []).join(', ');
                    return [item.ë§¤ì²´ëª… || '', categories, item.ë‹´ë‹¹ì || '', item.ì§ì±… || '', item.ì´ë©”ì¼ || '', item.íŒ€ë©”ì¼ || '', item.ì—°ë½ì²˜ || '', item['íŒë§¤ ëŒ€í–‰ì‚¬'] || '', item['ì†Œê°œì„œURL'] || ''].join('\t');
                });
                const textToCopy = [header, ...rows].join('\n');
                if(copyTextToClipboard(textToCopy)) { showToast(`${currentFilteredData.length}ê°œ ë§¤ì²´ì˜ ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`); } else { showToast('ì „ì²´ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'); }
            });

            editPatchNotesButton.addEventListener('click', handleEditPatchNotes);
            cancelPatchNotesButton.addEventListener('click', handleCancelPatchNotes);
            savePatchNotesButton.addEventListener('click', handleSavePatchNotes);

            // ===== ê¸°ëŠ¥ 1 ì¶”ê°€ ì‹œì‘ =====
            function updateThemeIcons() {
                if (document.documentElement.classList.contains('dark')) {
                    themeIconLight.classList.add('hidden');
                    themeIconDark.classList.remove('hidden');
                } else {
                    themeIconLight.classList.remove('hidden');
                    themeIconDark.classList.add('hidden');
                }
            }

            themeToggleButton.addEventListener('click', (e) => {
                e.preventDefault();
                // <html> íƒœê·¸ì˜ í´ë˜ìŠ¤ë¥¼ í† ê¸€
                document.documentElement.classList.toggle('dark');
                
                // localStorageì— ìƒíƒœ ì €ì¥
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.theme = 'dark';
                } else {
                    localStorage.theme = 'light';
                }
                
                // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                updateThemeIcons();
            });
            // ===== ê¸°ëŠ¥ 1 ì¶”ê°€ ì¢…ë£Œ =====
            
            scrollTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
            scrollBottomBtn.addEventListener('click', () => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); });
            window.addEventListener('scroll', () => {
                scrollTopBtn.classList.toggle('opacity-0', window.scrollY <= 200);
                scrollBottomBtn.classList.toggle('opacity-0', (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100);
            });
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled Promise Rejection:', event.reason);
                showToast('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });

            main();
        });
    </script>
</body>
</html>
