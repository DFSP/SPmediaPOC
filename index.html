<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[디지털퍼스트] 미디어 POC 리스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Tailwind CSS를 기본으로 사용하되, 추가적인 커스텀 스타일을 적용합니다. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            padding-bottom: 2.5rem; /* 하단 배너 공간 확보 */
        }
        #login-screen, #main-content {
            display: none; /* 기본적으로 모두 숨김 */
        }
        .toast-notification {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .category-tag {
            transition: all 0.2s ease-in-out;
        }
        input[type="file"] {
            display: none;
        }
        .edit-input {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .dark .edit-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        .edit-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .scrolling-banner-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }
        .scrolling-banner-content {
            display: inline-block;
            animation: marquee 30s linear infinite;
        }
        @keyframes marquee {
            from { transform: translateX(0%); }
            to { transform: translateX(var(--scroll-width)); }
        }
    </style>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    
    <div id="login-screen" class="flex min-h-screen items-center justify-center">
        <div class="w-full max-w-md rounded-lg bg-white p-8 text-center shadow-xl dark:bg-gray-800">
            <h1 class="mb-4 text-2xl font-bold text-gray-800 dark:text-white">[디지털퍼스트] 미디어 POC 리스트</h1>
            <p class="mb-8 text-sm text-gray-500 dark:text-gray-400">회사 Google 계정으로 로그인하세요.</p>
            <button id="login-button" class="inline-flex w-full items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-center text-sm font-medium text-gray-700 shadow-sm transition hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-700">
                <svg class="mr-2 h-4 w-4" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 177.2 56.5L357 137.9C332.3 115.8 293.8 98 248 98c-84.3 0-152.3 68.3-152.3 158s68 158 152.3 158c94.2 0 135.8-63.5 141.2-95.2H248v-65.7h239.2c.4 12.3.6 24.6.6 37.3z"></path></svg>
                Google 계정으로 로그인
            </button>
        </div>
    </div>
    
    <div id="main-content">
        <div class="scrolling-banner-container bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300">
            <div class="scrolling-banner-content py-1 text-xs font-semibold">
                <span>디지털퍼스트 내부 배포 자료입니다. URL외부 공유 금지.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            </div>
        </div>

        <div id="toast-container" class="fixed top-5 right-5 z-50"></div>
        
        <div class="container mx-auto p-4 md:p-8 max-w-5xl">
            <header class="relative mb-8 rounded-t-lg border-b-4 border-blue-600 bg-white py-8 text-center shadow-sm transition-colors duration-300 dark:bg-gray-800">
                
                <div id="user-menu-container" class="absolute top-6 right-6 z-20" style="display: none;">
                    <div class="relative">
                        <button id="user-menu-button" type="button" class="flex h-8 w-8 items-center justify-center rounded-full bg-white/80 dark:bg-gray-800/80 text-gray-500 dark:text-gray-400 ring-1 ring-gray-900/5 dark:ring-white/10 transition hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none" aria-expanded="false" aria-haspopup="true">
                            <span class="sr-only">사용자 메뉴 열기</span>
                            <img class="h-8 w-8 rounded-full" id="user-menu-img" alt="프로필">
                        </button>
                        <div id="user-menu-dropdown" class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
                            <div class="border-b border-gray-200 dark:border-gray-700 px-4 py-3">
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="user-menu-name"></p>
                                <p class="truncate text-xs text-gray-500 dark:text-gray-400" id="user-menu-email"></p>
                            </div>
                            <div class="py-1" role="none">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem" tabindex="-1">로그아웃</a>
                            </div>
                        </div>
                    </div>
                </div>

                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 md:text-4xl" title="Crafted by team.SP">[디지털퍼스트] 미디어 POC 리스트</h1>
                <p class="mt-2 text-gray-500 dark:text-gray-400">매체명을 검색하거나 카테고리를 선택하여 담당자 정보를 확인하세요.</p>
            </header>
            
            <main>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-6 transition-colors duration-300">
                    <div class="mb-4">
                        <label for="search-box" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">매체명/담당자 검색</label>
                        <input type="text" id="search-box" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="데이터베이스 연결 중...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">카테고리 선택 (중복 가능)</label>
                        <div id="category-tags-container" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                </div>

                <div id="add-new-button-wrapper" class="mb-6 text-right hidden">
                    <button id="add-new-card-button" class="bg-blue-600 text-white font-bold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md inline-flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        신규 추가
                    </button>

                    <a id="request-edit-button" href="https://docs.google.com/spreadsheets/d/1PX7vIIGh5dlIguyhhNJ20kz8fbYOVJgGuEWOf2tAVWA/edit?gid=0#gid=0" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white font-bold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md inline-flex items-center hidden">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        매체 정보 등록/수정 요청
                    </a>
                </div>

                <div id="media-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
                
                <div id="no-results" class="text-center py-16 px-6 bg-white dark:bg-gray-800 rounded-xl shadow-md hidden transition-colors duration-300">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-800 dark:text-gray-200">데이터를 찾을 수 없습니다.</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Firebase에 데이터가 없거나, 검색 결과가 없습니다.</p>
                </div>

                <div id="copy-all-container" class="mt-8 text-center hidden">
                    <button id="copy-all-button" class="bg-green-600 text-white font-bold text-sm py-2.5 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors shadow-lg">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        검색 결과 복사(paste to Excel)
                    </button>
                </div>
            </main>

            <footer class="text-center mt-12 py-4 border-t border-gray-200 dark:border-gray-700 transition-colors duration-300">
                 <div id="admin-upload-section" class="mb-2 hidden">
                     <label for="excel-upload" class="text-xs text-gray-500 dark:text-gray-400 underline cursor-pointer hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                         데이터파일 관리(SP팀)
                     </label>
                     <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv">
                     <span id="file-name" class="ml-2 text-xs text-gray-500"></span>
                 </div>
                 <div>
                     <p class="text-xs text-gray-400 dark:text-gray-500">copyright © digitalFirst All Right Reserved.</p>
                 </div>
            </footer>
        </div>

        <div class="fixed bottom-12 right-6 flex flex-col gap-2 z-40">
            <button id="scroll-to-top" title="맨 위로" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-opacity opacity-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
            </button>
            <button id="scroll-to-bottom" title="맨 아래로" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>

        <div class="scrolling-banner-container bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300 fixed bottom-0 left-0 z-30">
            <div class="scrolling-banner-content py-1 text-xs font-semibold">
                <span>디지털퍼스트 내부 배포 자료입니다. URL외부 공유 금지.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, updateDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            // --- 전역 변수 ---
            let mediaData = [];
            let currentFilteredData = [];
            let db, auth;
            let mediaCollectionRef;
            let isAdmin = false; // 사용자가 관리자인지 여부를 저장
            const ALLOWED_DOMAIN = "dfirst-inc.com";
            const ADMIN_EMAIL = "digitalfirst.sp@gmail.com"; 

            // --- DOM Element 참조 ---
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const loginButton = document.getElementById('login-button');
            const excelUpload = document.getElementById('excel-upload');
            const fileNameSpan = document.getElementById('file-name');
            const searchBox = document.getElementById('search-box');
            const categoryTagsContainer = document.getElementById('category-tags-container');
            const mediaList = document.getElementById('media-list');
            const copyAllButton = document.getElementById('copy-all-button');
            const copyAllContainer = document.getElementById('copy-all-container');
            const addNewCardButtonWrapper = document.getElementById('add-new-button-wrapper');
            const addNewCardButton = document.getElementById('add-new-card-button');
            const scrollTopBtn = document.getElementById('scroll-to-top');
            const scrollBottomBtn = document.getElementById('scroll-to-bottom');
            const noResults = document.getElementById('no-results');
            const userMenuContainer = document.getElementById('user-menu-container');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            const logoutButton = document.getElementById('logout-button');
            const adminUploadSection = document.getElementById('admin-upload-section');
            const requestEditButton = document.getElementById('request-edit-button'); 

            // --- 함수 선언 ---
            
            function initializeScrollingBanners() {
                const banners = document.querySelectorAll('.scrolling-banner-container');

                banners.forEach(banner => {
                    const content = banner.querySelector('.scrolling-banner-content');
                    if (!content) return;

                    // 1. 복제의 기준이 될 원본 span을 찾습니다.
                    const templateSpan = content.querySelector('span');
                    if (!templateSpan) return;
        
                    // innerHTML을 직접 조작하기 전에 원본을 복제해 둡니다.
                    const originalSpanHTML = templateSpan.outerHTML;
                    content.innerHTML = originalSpanHTML; // 내용물을 원본 span 하나로 초기화합니다.

                    const bannerWidth = banner.offsetWidth;
                    const spanWidth = templateSpan.offsetWidth;

                    if (bannerWidth === 0 || spanWidth === 0) {
                        // 너비 계산이 불가능하면 함수를 중단합니다.
                        return;
                    }

                    // 2. 화면 너비를 채우기 위해 필요한 span의 개수를 계산합니다.
                    //    (넉넉하게 1개 더 추가합니다.)
                    const spansToFill = Math.ceil(bannerWidth / spanWidth) + 1;
            
                    // 3. 무한 루프를 위해 내용물을 2배로 만듭니다.
                    const totalSpans = spansToFill * 2;
                    
                    let newHTML = '';
                    for (let i = 0; i < totalSpans; i++) {
                        newHTML += originalSpanHTML;
                    }
                    content.innerHTML = newHTML;
            
                    // 4. CSS 애니메이션이 이동해야 할 정확한 거리를 계산합니다.
                    //    (전체 너비의 절반만큼, 음수 값으로)
                    const scrollWidth = spansToFill * spanWidth;
            
                    // 5. 계산된 이동 거리를 CSS 변수(--scroll-width)에 설정합니다.
                    content.style.setProperty('--scroll-width', `-${scrollWidth}px`);
                });
            }
                       
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `${bgColor} text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg toast-notification opacity-0 transform translate-y-2`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.classList.remove('opacity-0', 'translate-y-2'); toast.classList.add('opacity-100', 'transform-none'); }, 10);
                setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => { toast.remove(); }, 500); }, 2000);
            }

            function generateCardView(item, isAdminUser) {
                const categoryTagsHtml = (item.카테고리 || []).map(cat => `<span class="text-xs font-semibold text-blue-800 bg-blue-100 dark:text-gray-200 dark:bg-gray-600 px-2 py-1 rounded-full">${cat}</span>`).join('');
                
                const adminButtonsHtml = isAdminUser ? `
                    <div class="flex flex-col items-end space-y-1 flex-shrink-0">
                        <button data-action="edit" data-id="${item.id}" class="text-xs text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400">수정</button>
                        <button data-action="delete" data-id="${item.id}" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400">삭제</button>
                    </div>` : '';

                let infoHtml = '';
                const createRow = (label, value, clipValue) => {
                    if (!value) return '';
                    const copyButton = clipValue ? `<button class="copy-button ml-auto shrink-0" data-clipboard="${clipValue}" aria-label="${label} 복사"><svg class="w-5 h-5 text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>` : '';
                    return `<div class="flex items-center gap-2"><span class="font-semibold text-gray-500 dark:text-gray-400 w-20 shrink-0">${label}</span><div class="hover-scroll-container flex-grow min-w-0"><span class="truncate block">${value}</span></div>${copyButton}</div>`;
                };
                const contactPerson = item.담당자 ? `${item.담당자}${item.직책 ? ` / ${item.직책}` : ''}` : '';
                infoHtml += createRow('담당자', contactPerson);
                infoHtml += createRow('이메일', item.이메일, item.이메일);
                infoHtml += createRow('팀메일', item.팀메일, item.팀메일);
                infoHtml += createRow('연락처', item.연락처, item.연락처);
                infoHtml += createRow('판매 대행사', item['판매 대행사'], item['판매 대행사']);
                const introButtonHtml = item['소개서URL'] ? `<a href="${item['소개서URL']}" target="_blank" rel="noopener noreferrer" class="w-full text-center block bg-blue-600 text-white font-semibold text-sm py-2 px-4 rounded-lg hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 transition-colors">소개서 다운로드</a>` : `<button class="w-full text-center block bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-semibold text-sm py-2 px-4 rounded-lg cursor-not-allowed" disabled>소개서 없음</button>`;
                
                return `<div class="flex justify-between items-start gap-2 mb-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 break-words" title="${item.매체명 || ''}">${item.매체명 || ''}</h2>
                            ${adminButtonsHtml}
                        </div>
                        <div class="flex-grow">
                            <div class="flex flex-wrap gap-2 mb-4">${categoryTagsHtml}</div>
                            <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">${infoHtml}</div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">${introButtonHtml}</div>`;
            }

            function generateCardEditView(item) {
                const createInput = (name, label, value) => `<div class="mb-2"><label class="block text-xs font-medium text-gray-500 dark:text-gray-400">${label}</label><input type="text" name="${name}" value="${value || ''}" class="edit-input"></div>`;
                return `<form data-id="${item.id || ''}">${createInput('매체명', '매체명', item.매체명)}${createInput('카테고리', '카테고리 (쉼표로 구분)', (item.카테고리 || []).join(', '))}${createInput('담당자', '담당자', item.담당자)}${createInput('직책', '직책', item.직책)}${createInput('이메일', '이메일', item.이메일)}${createInput('팀메일', '팀메일', item.팀메일)}${createInput('연락처', '연락처', item.연락처)}${createInput('판매 대행사', '판매 대행사', item['판매 대행사'])}${createInput('소개서URL', '소개서URL', item['소개서URL'])}<div class="flex justify-end gap-2 mt-4"><button type="button" data-action="cancel" data-id="${item.id || ''}" class="px-3 py-1 text-sm rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">취소</button><button type="button" data-action="save" data-id="${item.id || ''}" class="px-3 py-1 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">저장</button></div></form>`;
            }
            
            function renderMedia(data) {
                const newCard = document.querySelector('[data-is-new="true"]');
                mediaList.innerHTML = '';
                if (newCard) {
                    mediaList.appendChild(newCard);
                }
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.id = `card-${item.id}`;
                    card.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 flex flex-col transition-transform transform hover:-translate-y-1 transition-colors duration-300';
                    card.innerHTML = generateCardView(item, isAdmin);
                    mediaList.appendChild(card);
                });
                const hasContentToShow = mediaList.hasChildNodes();
                noResults.classList.toggle('hidden', hasContentToShow);
                copyAllContainer.classList.toggle('hidden', !hasContentToShow || !!newCard);
            }
            
            function filterAndRender() {
                const searchTerm = searchBox.value.toLowerCase().replace(/\s/g, '');
                const selectedCategoryNodes = categoryTagsContainer.querySelectorAll('.bg-blue-600, .dark\\:bg-blue-500');
                const selectedCategories = Array.from(selectedCategoryNodes).map(node => node.dataset.category);
                
                const filteredData = mediaData.filter(item => {
                    const matchesSearch = (item.매체명 || '').toLowerCase().replace(/\s/g, '').includes(searchTerm) || (item.담당자 || '').toLowerCase().replace(/\s/g, '').includes(searchTerm) || (item['판매 대행사'] || '').toLowerCase().replace(/\s/g, '').includes(searchTerm);
                    if (selectedCategories.length === 0) { return matchesSearch; }
                    const matchesCategory = selectedCategories.some(cat => (item.카테고리 || []).includes(cat));
                    return matchesSearch && matchesCategory;
                });
                
                currentFilteredData = filteredData;
                renderMedia(filteredData);
            }

            function initializeUIWithData(data) {
                mediaData = data;
                populateCategories();
                updateSearchPlaceholder();
                filterAndRender();
            }

            function processExcelData(rawData) {
                return rawData.map(row => {
                    const safeRow = (typeof row === 'object' && row !== null) ? row : {};
                    return { ...safeRow, 카테고리: (safeRow.카테고리 && typeof safeRow.카테고리 === 'string') ? safeRow.카테고리.split(',').map(cat => cat.trim()).filter(Boolean) : (Array.isArray(safeRow.카테고리) ? safeRow.카테고리 : []) };
                });
            }

            function updateSearchPlaceholder() {
                if (mediaData.length > 0) {
                    const exampleMedia = mediaData[0]?.매체명 || '';
                    const examplePoc = mediaData[0]?.담당자 || '';
                    let placeholderText = '예: ';
                    if (exampleMedia) placeholderText += `${exampleMedia}`;
                    if (examplePoc) placeholderText += `${exampleMedia ? ', ' : ''}${examplePoc}`;
                    searchBox.placeholder = placeholderText === '예: ' ? '매체명 또는 담당자 검색...' : placeholderText + '...';
                } else {
                    searchBox.placeholder = '데이터가 없습니다. 엑셀 파일을 업로드해주세요.';
                }
            }
            
            function populateCategories() {
                const activeCategories = new Set(Array.from(categoryTagsContainer.querySelectorAll('.bg-blue-600, .dark\\:bg-blue-500')).map(tag => tag.dataset.category));
                categoryTagsContainer.innerHTML = '';
                const allCategories = new Set(mediaData.flatMap(item => item.카테고리).filter(Boolean));
                const sortedCategories = [...allCategories].sort((a,b) => a.localeCompare(b, 'ko'));
                sortedCategories.forEach(category => {
                    const button = document.createElement('button');
                    if (activeCategories.has(category)) {
                        button.className = 'category-tag px-3 py-1.5 rounded-full text-sm font-semibold bg-blue-600 dark:bg-blue-500 text-white dark:text-white';
                    } else {
                        button.className = 'category-tag px-3 py-1.5 rounded-full text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600';
                    }
                    button.textContent = category;
                    button.dataset.category = category;
                    categoryTagsContainer.appendChild(button);
                });
            }

            function copyTextToClipboard(textToCopy) {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                let success = false;
                try { success = document.execCommand('copy'); } catch (err) { success = false; }
                document.body.removeChild(textArea);
                return success;
            }

            async function uploadDataToFirebase(dataToUpload) {
                showToast('데이터를 Firebase에 업로드 중입니다...', 'success');
                try {
                    const existingDocs = await getDocs(mediaCollectionRef);
                    const deleteBatch = writeBatch(db);
                    existingDocs.forEach(doc => { deleteBatch.delete(doc.ref); });
                    await deleteBatch.commit();
                    const addBatch = writeBatch(db);
                    dataToUpload.forEach(item => {
                        const docRef = doc(mediaCollectionRef);
                        addBatch.set(docRef, item);
                    });
                    await addBatch.commit();
                    showToast(`${dataToUpload.length}개의 데이터를 성공적으로 업로드했습니다.`, 'success');
                    mediaData = [];      // 1. 로컬 데이터를 완전히 비웁니다.
                    filterAndRender();   // 2. 비어있는 상태로 화면을 즉시 다시 그립니다.
                } catch (error) {
                    console.error("Firebase 업로드 오류:", error);
                    showToast("Firebase에 데이터를 업로드하는 중 오류가 발생했습니다.", "error");
                }
            }

            let firestoreUnsubscribe = null;
            function initializeFirestoreListener() {
                if (firestoreUnsubscribe) firestoreUnsubscribe(); 
                
                firestoreUnsubscribe = onSnapshot(mediaCollectionRef, (snapshot) => {
                    if (snapshot.empty || snapshot.docChanges().length === 0) {
                        return;
                    }
                    snapshot.docChanges().forEach((change) => {
                        const changedData = { id: change.doc.id, ...change.doc.data() };
                        if (change.type === "added") {
                            const isDuplicate = mediaData.some(item => item.id === change.doc.id);
                            if (!isDuplicate) {
                                mediaData.push(changedData);
                            }
                        }
                        if (change.type === "modified") {
                            const index = mediaData.findIndex(item => item.id === change.doc.id);
                            if (index > -1) {
                                mediaData[index] = changedData;
                            }
                        }
                        if (change.type === "removed") {
                            mediaData = mediaData.filter(item => item.id !== change.doc.id);
                        }
                    });
                    mediaData.sort((a, b) => (a.매체명 || '').localeCompare(b.매체명 || '', 'ko'));
                    filterAndRender(); 
                    populateCategories();
                }, (error) => {
                    console.error("실시간 데이터 감지 오류: ", error);
                    showToast("데이터를 실시간으로 가져오는 데 실패했습니다.", "error");
                });
            }
            
            function setupUserInfo(user) {
                const userImg = document.getElementById('user-menu-img');
                const userName = document.getElementById('user-menu-name');
                const userEmail = document.getElementById('user-menu-email');

                if (user) {
                    userImg.src = user.photoURL || `https://placehold.co/32x32/e2e8f0/64748b?text=${(user.displayName || user.email)[0]}`;
                    userName.textContent = user.displayName || '사용자';
                    userEmail.textContent = user.email;
                }
            }

            // --- 메인 실행 로직 ---
            async function main() {
                try {
                    const firebaseConfig = __firebase_config;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    mediaCollectionRef = collection(db, `artifacts/${appId}/public/data/mediaPocData`);

                    onAuthStateChanged(auth, (user) => {
                        if (!user) {
                            loginScreen.style.display = 'flex';
                            mainContent.style.display = 'none';
                            userMenuContainer.style.display = 'none';
                            addNewCardButtonWrapper.classList.add('hidden');
                            adminUploadSection.classList.add('hidden');
                            return;
                        }
                        
                        const isAuthorized = user.email.endsWith(`@${ALLOWED_DOMAIN}`) || user.email === ADMIN_EMAIL;
                        isAdmin = user.email === ADMIN_EMAIL;
                        
                        if (isAuthorized) {
                            loginScreen.style.display = 'none';
                            mainContent.style.display = 'block';

                            initializeScrollingBanners();
                            window.addEventListener('resize', initializeScrollingBanners);
                            
                            userMenuContainer.style.display = 'block';
                            setupUserInfo(user);
                            
                            addNewCardButtonWrapper.classList.remove('hidden');
                            if (isAdmin) {
                                addNewCardButton.classList.remove('hidden');
                                requestEditButton.classList.add('hidden');
                                adminUploadSection.classList.remove('hidden');
                            } else {
                                 addNewCardButton.classList.add('hidden');
                                requestEditButton.classList.remove('hidden');
                                adminUploadSection.classList.add('hidden');
                            }

                            getDocs(mediaCollectionRef).then(querySnapshot => {
                                let initialData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                initialData.sort((a, b) => (a.매체명 || '').localeCompare(b.매체명 || '', 'ko'));
                                initializeUIWithData(initialData);
                                initializeFirestoreListener();
                            }).catch(error => {
                                console.error("최초 데이터 로딩 오류:", error);
                                showToast("데이터를 가져오는 데 실패했습니다.", "error");
                            });
                        } else {
                            showToast("허용되지 않은 계정입니다.", "error");
                            signOut(auth); 
                        }
                    });
                } catch (e) {
                    console.error("Firebase 초기화 오류:", e);
                    showToast("Firebase 연결에 실패했습니다. 설정을 확인하세요.", "error");
                    loginScreen.innerHTML = `<div class="text-center text-red-500">Firebase 연결 실패! 관리자에게 문의하세요.</div>`;
                    loginScreen.style.display = 'flex';
                }

                userMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('hidden');
                });
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    signOut(auth).catch(error => showToast("로그아웃 실패", "error"));
                });
                window.addEventListener('click', (e) => {
                    if (userMenuButton && userMenuDropdown && !userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                        userMenuDropdown.classList.add('hidden');
                    }
                });
            }
            
            loginButton.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch((error) => {
                    console.error("Google 로그인 오류:", error);
                    showToast("Google 로그인에 실패했습니다.", "error");
                });
            });
            
            addNewCardButton.addEventListener('click', () => {
                if (document.querySelector('[data-is-new="true"]')) {
                    showToast("먼저 작성 중인 새 항목을 저장하거나 취소해주세요.", "error");
                    return;
                }
                const newItemData = { 매체명: '', 카테고리: [] };
                const tempCard = document.createElement('div');
                tempCard.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 flex flex-col';
                tempCard.dataset.isNew = 'true';
                tempCard.innerHTML = generateCardEditView(newItemData);
                mediaList.prepend(tempCard);
                tempCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                tempCard.querySelector('input[name="매체명"]')?.focus();
            });

            excelUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !db) { showToast("Firebase가 아직 연결되지 않았습니다.", "error"); return; };
                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        const processedData = processExcelData(jsonData);
                        uploadDataToFirebase(processedData);
                    } catch (error) {
                        console.error("파일 처리 중 오류 발생:", error);
                        showToast("파일을 처리하는 중 오류가 발생했습니다. 파일 형식을 확인해주세요.", "error");
                    }
                };
                reader.onerror = (error) => { console.error("파일 읽기 오류:", error); showToast("파일을 읽는 데 실패했습니다.", "error"); };
                reader.readAsArrayBuffer(file);
            });

            categoryTagsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.category-tag');
                if (!target) return;
                target.classList.toggle('bg-blue-600');
                target.classList.toggle('dark:bg-blue-500');
                target.classList.toggle('text-white');
                target.classList.toggle('dark:text-white');
                target.classList.toggle('bg-gray-200');
                target.classList.toggle('dark:bg-gray-700');
                target.classList.toggle('text-gray-700');
                target.classList.toggle('dark:text-gray-300');
                filterAndRender();
            });

            let debounceTimer;
            searchBox.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(filterAndRender, 200); });
            
            mediaList.addEventListener('click', async function(e) {
                const button = e.target.closest('button');
                if (!button) return;
                const cardElement = button.closest('[id^="card-"], [data-is-new="true"]');
                if (!cardElement) return;
                if (button.classList.contains('copy-button')) {
                    const textToCopy = button.dataset.clipboard;
                    if (copyTextToClipboard(textToCopy)) {
                        showToast(`'${textToCopy}' 복사 완료!`);
                        button.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                        setTimeout(() => { button.innerHTML = `<svg class="w-5 h-5 text-gray-400 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`; }, 1500);
                    } else { showToast('복사에 실패했습니다.', 'error'); }
                    return;
                }
                const action = button.dataset.action;
                const isNew = cardElement.dataset.isNew === 'true';
                const id = isNew ? null : cardElement.id.replace('card-', '');
                const item = isNew ? null : mediaData.find(item => item.id === id);
                if (!isNew && !item) return;
                const docRef = id ? doc(db, mediaCollectionRef.path, id) : null;
                if (action === 'edit') {
                    cardElement.innerHTML = generateCardEditView(item);
                } else if (action === 'delete') {
                    cardElement.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-4"><p class="text-sm text-gray-800 dark:text-gray-200 text-center font-semibold mb-4">정말로 삭제하시겠습니까?</p><div class="flex space-x-2"><button type="button" data-action="cancel-delete" data-id="${id}" class="px-3 py-1 text-sm rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">취소</button><button type="button" data-action="confirm-delete" data-id="${id}" class="px-3 py-1 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">확인</button></div></div>`;
                } else if (action === 'confirm-delete') {
                    if (!docRef) return;
                    try { await deleteDoc(docRef); showToast('삭제되었습니다.', 'success'); } catch (error) { console.error("삭제 오류: ", error); showToast("삭제에 실패했습니다.", "error"); if(item) cardElement.innerHTML = generateCardView(item, isAdmin); }
                } else if (action === 'cancel') {
                    if (isNew) { cardElement.remove(); } else { cardElement.innerHTML = generateCardView(item, isAdmin); }
                } else if (action === 'save') {
                    const form = cardElement.querySelector('form');
                    const formData = new FormData(form);
                    const updatedItemData = {};
                    for (let [key, value] of formData.entries()) {
                        if (key === '카테고리') { updatedItemData[key] = value.split(',').map(v => v.trim()).filter(Boolean); } else { updatedItemData[key] = value; }
                    }
                    try {
                        if (isNew) {
                            await addDoc(mediaCollectionRef, updatedItemData);
                            cardElement.remove();
                        } else {
                            if (!docRef) return;
                            await updateDoc(docRef, updatedItemData);
                        }
                        showToast('성공적으로 저장되었습니다.', 'success');
                    } catch (error) {
                        console.error("저장 오류: ", error);
                        showToast("저장에 실패했습니다.", "error");
                    }
                }
            });
            copyAllButton.addEventListener('click', () => {
                if (currentFilteredData.length === 0) { showToast('복사할 데이터가 없습니다.', 'error'); return; }
                const header = "매체명\t카테고리\t담당자\t직책\t이메일\t팀메일\t연락처\t판매 대행사\t소개서URL";
                const rows = currentFilteredData.map(item => {
                    const categories = (item.카테고리 || []).join(', ');
                    return [item.매체명 || '', categories, item.담당자 || '', item.직책 || '', item.이메일 || '', item.팀메일 || '', item.연락처 || '', item['판매 대행사'] || '', item['소개서URL'] || ''].join('\t');
                });
                const textToCopy = [header, ...rows].join('\n');
                if(copyTextToClipboard(textToCopy)) { showToast(`${currentFilteredData.length}개 매체의 정보가 복사되었습니다!`); } else { showToast('전체 복사에 실패했습니다.', 'error'); }
            });
            scrollTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
            scrollBottomBtn.addEventListener('click', () => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); });
            window.addEventListener('scroll', () => {
                scrollTopBtn.classList.toggle('opacity-0', window.scrollY <= 200);
                scrollBottomBtn.classList.toggle('opacity-0', (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100);
            });
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled Promise Rejection:', event.reason);
                showToast('예상치 못한 오류가 발생했습니다.', 'error');
            });
            
            main();
         });
    </script>
</body>
</html>
